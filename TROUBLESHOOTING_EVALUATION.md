# 评估功能故障排除

## 问题：点击"开始评估"按钮没有反应

### 可能原因 1：浏览器控制台有错误

**解决方法：**

1. 打开浏览器开发者工具
   - **Chrome/Edge**: 按 F12 或右键 → 检查
   - **Firefox**: 按 F12 或右键 → 检查元素
   - **Safari**: 开发 → 显示 Web 检查器

2. 切换到 Console（控制台）标签

3. 查看是否有错误信息

4. 如果有错误，请记录错误信息

### 可能原因 2：没有填写所有必填字段

**解决方法：**

确保填写了以下所有字段：
- ✓ 查询问题
- ✓ 检索到的文档
- ✓ 真实相关文档（标准答案）

### 可能原因 3：网络请求被阻止

**解决方法：**

检查浏览器的 Network（网络）标签：
1. 打开开发者工具
2. 切换到 Network 标签
3. 点击"开始评估"
4. 查看是否有红色的请求失败

如果请求失败，可能是：
- API 服务未运行
- 跨域问题（CORS）
- 防火墙阻止

### 可能原因 4：JavaScript 加载失败

**解决方法：**

1. 刷新页面（F5 或 Cmd+R）
2. 清除浏览器缓存
3. 尝试其他浏览器（Chrome、Firefox、Safari）

## 使用测试页面进行诊断

访问测试页面：
```
http://localhost:8000/static/evaluation_test.html
```

测试页面包含以下功能：
1. ✓ 测试页面加载
2. ✓ 测试 API 连接
3. ✓ 测试获取检索结果
4. ✓ 测试评估功能
5. ✓ 详细的日志输出

## 正确的使用步骤

### 步骤 1：打开评估页面
```
http://localhost:8000/static/evaluation.html
```

### 步骤 2：输入查询问题
在"查询问题"输入框中输入你想评估的问题
- 例如：`高血压饮食建议`

### 步骤 3：获取检索结果（可选）
点击"从系统获取检索结果"按钮
- 系统会自动从 RAG 系统获取相关文档
- 文档会填充到"检索到的文档"文本框

### 步骤 4：标注标准答案（重要！）
在"真实相关文档"文本框中输入你认为真正相关的文档

**两种方式：**

**方式 1：从检索结果中选择**
1. 查看"检索到的文档"中的内容
2. 复制你认为相关的文档
3. 粘贴到"真实相关文档"文本框

**方式 2：根据知识手动标注**
1. 根据你的知识
2. 判断哪些文档应该被检索到
3. 手动输入到"真实相关文档"文本框

### 步骤 5：执行评估
点击"开始评估"按钮
- 查看评估结果
- 分析 Precision、Recall、F1-Score

## 示例：评估"高血压饮食建议"

### 1. 输入查询
```
高血压饮食建议
```

### 2. 获取检索结果
点击"从系统获取检索结果"，系统返回：

```
第二章：高血压患者的饮食原则
高血压患者的饮食控制非常重要...

第六章：高血压并发症的饮食注意事项
高血压常见的并发症包括...

第五章：高血压的药物治疗原则
药物治疗是高血压管理的重要手段...
```

### 3. 标注标准答案
假设你认为前2个文档是相关的：

```
第二章：高血压患者的饮食原则
高血压患者的饮食控制非常重要...

第六章：高血压并发症的饮食注意事项
高血压常见的并发症包括...
```

### 4. 执行评估
点击"开始评估"，结果：

```
Precision: 0.6667 (66.67%)
Recall: 1.0000 (100.00%)
F1-Score: 0.8000 (80.00%)
```

### 5. 分析结果
- ✓ Recall 100%: 所有相关文档都被检索到了
- ✓ Precision 66.67%: 检索结果中 2/3 是相关的
- ✓ F1-Score 80%: 综合质量良好

## 常见错误及解决方法

### 错误 1：评估失败：请输入查询问题
**原因**：查询问题输入框为空
**解决**：在"查询问题"输入框中输入内容

### 错误 2：评估失败：请输入检索到的文档
**原因**：检索到的文档输入框为空
**解决**：手动输入或点击"从系统获取检索结果"

### 错误 3：评估失败：请输入真实相关文档
**原因**：标准答案输入框为空
**解决**：手动输入你认为相关的文档

### 错误 4：评估失败：HTTP 404 Not Found
**原因**：API 路由未正确注册或服务未启动
**解决**：
1. 检查服务是否运行：`curl http://localhost:8000/health`
2. 如果未运行，启动服务：`docker-compose up -d`
3. 如果需要重新构建：`docker-compose up -d --build`

### 错误 5：评估失败：Network Error
**原因**：网络连接问题或跨域限制
**解决**：
1. 检查服务是否在 localhost:8000 运行
2. 检查防火墙设置
3. 尝试使用其他浏览器

## 使用 Python 脚本进行测试

如果 Web 界面有问题，可以使用 Python 脚本：

```bash
cd /Users/baozhen/CodeBuddy/medical-model-training/enterprise_rag
python3 test_evaluation_simple.py
```

这会：
1. 从系统获取检索结果
2. 执行评估
3. 显示详细结果

## 使用 API 直接测试

使用 curl 测试：

```bash
curl -X POST http://localhost:8000/api/v1/evaluation/retrieval \
  -H "Content-Type: application/json" \
  -d '{
    "query": "高血压饮食建议",
    "retrieved_docs": ["文档1", "文档2", "文档3"],
    "ground_truth_docs": ["文档1", "文档2"],
    "use_ai_rating": false
  }'
```

## 查看浏览器控制台日志

如果点击按钮没有反应，按 F12 打开开发者工具，查看 Console：

### 正常的日志应该显示：
```
开始评估...
查询问题: 高血压饮食建议
检索到的文档数: 3
标准答案文档数: 2
准备发送请求...
请求数据: {...}
收到响应，状态码: 200
评估结果: {...}
```

### 如果有错误，会显示：
```
✗ 评估失败: TypeError: ...
或者
✗ 评估失败: NetworkError: ...
```

## 检查服务状态

```bash
# 检查服务是否运行
curl http://localhost:8000/health

# 检查 Docker 容器状态
docker-compose ps

# 查看服务日志
docker-compose logs -f api
```

## 重新部署服务

如果所有方法都失败，尝试重新部署：

```bash
cd /Users/baozhen/CodeBuddy/medical-model-training/enterprise_rag

# 停止并删除容器
docker-compose down

# 重新构建并启动
docker-compose up -d --build

# 等待服务启动
sleep 10

# 检查服务状态
curl http://localhost:8000/health
```

## 联系支持

如果问题仍然存在，请提供以下信息：

1. 浏览器类型和版本
2. 浏览器控制台的错误截图
3. Network 标签中的请求信息
4. 服务运行状态：`docker-compose ps`
5. 服务日志：`docker-compose logs api`

## 相关文档

- `EVALUATION_GUIDE.md` - 评估功能详细指南
- `EVALUATION_USAGE.md` - 使用说明
- `test_evaluation_simple.py` - Python 测试脚本
- `static/evaluation_test.html` - 测试页面
