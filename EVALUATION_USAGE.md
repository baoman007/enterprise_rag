# 评估功能使用说明

## 功能概述

评估功能用于评估 RAG 系统的检索质量，计算以下指标：
- **Precision（精确率）**：检索结果中有多少是相关的
- **Recall（召回率）**：相关文档中有多少被检索到
- **F1-Score**：精确率和召回率的调和平均数

## 使用步骤

### 方法 1: 使用 Web 界面（推荐）

1. **打开评估页面**
   ```
   http://localhost:8000/static/evaluation.html
   ```

2. **输入查询问题**
   - 在"查询问题"输入框中输入你想评估的问题
   - 例如：`高血压饮食建议`

3. **获取检索结果**
   - 点击"从系统获取检索结果"按钮
   - 系统会自动从 RAG 系统检索相关文档并填充到"检索到的文档"文本框

4. **标注标准答案**
   - 在"真实相关文档"文本框中，手动输入你认为真正相关的文档
   - 可以从"检索到的文档"中选择相关的复制过来
   - 或者根据你的知识标注应该检索到的文档

5. **执行评估**
   - （可选）勾选"使用 AI 辅助评分"
   - 点击"开始评估"按钮
   - 查看评估结果

### 方法 2: 使用 Python 脚本

运行测试脚本：
```bash
python3 test_evaluation_simple.py
```

### 方法 3: 直接调用 API

```bash
curl -X POST http://localhost:8000/api/v1/evaluation/retrieval \
  -H "Content-Type: application/json" \
  -d '{
    "query": "高血压饮食建议",
    "retrieved_docs": [
      "文档1内容",
      "文档2内容"
    ],
    "ground_truth_docs": [
      "相关文档1",
      "相关文档2"
    ],
    "use_ai_rating": false
  }'
```

## 评估结果解读

### 示例结果

```
Precision: 0.2000 (20.00%)
Recall: 0.3333 (33.33%)
F1-Score: 0.2500 (25.00%)

检索统计:
- 检索到文档数: 5
- 真实相关文档数: 3
- 检索到且相关: 1 ✓
- 遗漏的相关文档: 2 ✗
```

### 指标含义

| 指标 | 含义 | 计算 | 理想值 |
|------|------|------|--------|
| **Precision** | 检索结果中相关文档的比例 | 1/5 = 0.20 | 接近 1.0 |
| **Recall** | 相关文档被检索到的比例 | 1/3 = 0.33 | 接近 1.0 |
| **F1-Score** | P 和 R 的综合评价 | 2×0.2×0.33/(0.2+0.33) | 接近 1.0 |

### 结果分析

- **Precision 高，Recall 低**：检索结果很准确，但可能遗漏了一些相关文档
- **Precision 低，Recall 高**：检索到了很多文档，但其中很多不相关
- **两者都高**：检索系统质量好
- **两者都低**：检索系统需要改进

## 实际应用示例

### 示例 1：评估"高血压饮食建议"

**查询**：高血压饮食建议

**检索到的文档**（系统自动获取）：
1. 第二章：高血压患者的饮食原则
2. 第二章：高血压患者的饮食原则
3. 第六章：高血压并发症的饮食注意事项
4. 第六章：高血压并发症的饮食注意事项
5. 第五章：高血压的药物治疗原则

**标准答案（人工标注）**：
1. 第二章：高血压患者的饮食原则
2. 第六章：高血压并发症的饮食注意事项

**评估结果**：
- Precision = 2/5 = 40%
- Recall = 2/2 = 100%
- F1-Score = 57.14%

**分析**：
- ✓ 召回率很好，所有相关文档都被检索到了
- ✗ 精确率较低，检索结果中包含了一些不相关的文档（如药物治疗）
- **建议**：可以提高相似度阈值或优化检索算法

### 示例 2：评估"糖尿病预防"

**查询**：糖尿病预防

**检索到的文档**：
1. 糖尿病的预防措施
2. 糖尿病的高危人群
3. 糖尿病的早期症状
4. 糖尿病的并发症

**标准答案**：
1. 糖尿病的预防措施
2. 糖尿病的高危人群
3. 生活方式干预

**评估结果**：
- Precision = 2/4 = 50%
- Recall = 2/3 = 66.67%
- F1-Score = 57.14%

**分析**：
- 检索系统找到了大部分相关文档
- 但遗漏了"生活方式干预"这个重要文档
- **建议**：扩充知识库或优化检索算法

## 如何构建标准答案

### 1. 人工标注（推荐）

- 由领域专家标注
- 根据查询问题，判断哪些文档是真正相关的
- 可以多人标注，取交集或平均

### 2. 使用现有检索结果

- 获取系统检索结果
- 手动筛选出真正相关的文档
- 作为标准答案

### 3. 基于知识库构建

- 浏览知识库文档
- 根据查询内容，找到相关文档
- 构建标准答案

## 优化建议

### 提高 Precision

1. **提高相似度阈值**
   ```python
   # 在 .env 文件中修改
   SIMILARITY_THRESHOLD=0.3  # 从 0.2 提高到 0.3
   ```

2. **优化嵌入模型**
   - 使用更高质量的嵌入模型
   - 针对特定领域微调模型

3. **添加重排序**
   - 使用交叉编码器重新排序检索结果
   - 过滤掉不相关的文档

### 提高 Recall

1. **降低相似度阈值**
   ```python
   SIMILARITY_THRESHOLD=0.1  # 从 0.2 降低到 0.1
   ```

2. **增加 Top-K 数量**
   ```python
   # 在 API 请求中增加 max_results
   {"max_results": 10}
   ```

3. **扩充知识库**
   - 添加更多相关文档
   - 确保覆盖各个主题

4. **查询扩展**
   - 使用同义词扩展查询
   - 使用多查询融合

## 常见问题

### Q1: 为什么评估结果显示 0% 相关？

可能原因：
- 检索到的文档与标准答案内容不匹配
- 标准答案标注不准确
- 文档内容被截断或不完整

解决方法：
- 检查检索到的文档内容
- 重新标注标准答案
- 确保文档内容完整

### Q2: 如何确定合理的 Precision 和 Recall？

根据业务场景：
- **医学检索**：优先保证 Recall（不遗漏重要信息）
- **推荐系统**：优先保证 Precision（提高用户满意度）
- **通用搜索**：平衡两者

### Q3: AI 辅助评分有用吗？

AI 评分提供参考，但不应该完全依赖：
- 可以发现人工标注遗漏的相关文档
- 提供改进建议
- 建议结合人工评估

### Q4: 需要评估多少个查询？

建议：
- 最少 50-100 个查询
- 涵盖不同类型（简单、复杂、多意图）
- 定期更新测试集

## 技术细节

### API 端点

- `POST /api/v1/evaluation/retrieval` - 单次评估
- `POST /api/v1/evaluation/batch` - 批量评估
- `GET /api/v1/evaluation/report` - 获取评估报告
- `POST /api/v1/medical/rag-process` - 获取检索结果

### 数据格式

```json
{
  "query": "高血压饮食建议",
  "retrieved_docs": ["文档1", "文档2"],
  "ground_truth_docs": ["相关1", "相关2"],
  "use_ai_rating": false
}
```

### 响应格式

```json
{
  "query": "查询问题",
  "retrieved_docs_count": 5,
  "ground_truth_docs_count": 3,
  "relevant_retrieved_count": 2,
  "missed_docs_count": 1,
  "precision": 0.4,
  "recall": 0.6667,
  "f1_score": 0.5,
  "relevant_retrieved_docs": ["相关文档1"],
  "missed_docs": ["遗漏的文档"]
}
```

## 相关文件

- `/api/services/evaluation_service.py` - 评估服务实现
- `/api/routers/evaluation.py` - 评估 API
- `/static/evaluation.html` - 评估 Web 界面
- `test_evaluation_simple.py` - 测试脚本
- `EVALUATION_GUIDE.md` - 详细指南
